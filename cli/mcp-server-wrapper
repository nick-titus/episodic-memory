#!/bin/bash
# Wrapper script for MCP server that ensures dependencies are installed
# This runs before the MCP server starts

# Determine plugin root directory
if [ -n "$CLAUDE_PLUGIN_ROOT" ]; then
  PLUGIN_ROOT="$CLAUDE_PLUGIN_ROOT"
else
  # Fall back to script directory
  SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
  PLUGIN_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
fi

# Check if node_modules exists
if [ ! -d "$PLUGIN_ROOT/node_modules" ]; then
  echo "Installing episodic-memory dependencies (first run only)..." >&2
  (cd "$PLUGIN_ROOT" && npm install --loglevel=error) >&2
  if [ $? -eq 0 ]; then
    echo "Dependencies installed successfully." >&2
  else
    echo "ERROR: Failed to install dependencies. Please run: cd \"$PLUGIN_ROOT\" && npm install" >&2
    exit 1
  fi
fi

# Start the MCP server
exec node "$PLUGIN_ROOT/dist/mcp-server.js"
